{"version":3,"sources":["src\\utils\\request.js"],"names":["request","confirmCount","fetch","options","method","data","url","auth","Cookie","get","config","cookie","timeout","reqTimeout","headers","hasUrl","arr","flag","map","k","i","indexOf","exAuthArr","requestApiUrl","getValidateImg","exAppIdArr","appId","exAuthArr1","mock","toLowerCase","axios","qs","stringify","delete","head","newData","post","putData","put","patch","go2Login","isReload","localStorage","removeItem","sessionStorage","remove","userName","sysType","userInfoKey","checkLogin","isHandCommErr","title","description","Promise","reject","resultCode","resultMsg","apiAppName","emojiData","JSON","emojiRegRule","match","then","response","statusText","status","isCross","query","results","json","cRes","catch","error","errDesc"],"mappings":"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","file":"request.js","sourceRoot":"C:/Users/liu.ping/helloReact","sourcesContent":["import axios from 'axios'\r\nimport qs from 'qs'\r\nimport config from '../config/config'\r\nimport {reqInform, showConfirm} from './notification'\r\nimport Cookie from 'js-cookie'\r\nimport {hashHistory} from 'dva/router'\r\nimport {join,get} from 'lodash'\r\nimport { messageInform } from '../utils/notification'\r\nimport {getLocalData} from '../utils/globalScope'\r\nimport toBase64 from './toBase64'\r\n// 登录跳转的方法\r\nimport { customLoginRedirect } from '../utils/redirect_utils'\r\n\r\n// 弹窗次数\r\nlet confirmCount = 0\r\n\r\nconst fetch = (options) => {\r\n  const {method = 'post', data, url, auth = Cookie.get(config.cookie.auth), timeout = config.reqTimeout } = options\r\n  // 取出headers\r\n  let {headers} = options;\r\n  headers = headers ? headers : {}\r\n  //解决ie不重新请求问题\r\n  headers = {\r\n    ...headers,\r\n    'auth': auth,\r\n    'Cache-Control': 'no-cache',\r\n    'Pragma': 'no-cache',\r\n    'Expires': -1\r\n  }\r\n\r\n  if (!headers['Content-type']) {\r\n    headers['Content-type'] = 'application/x-www-form-urlencoded';\r\n  }\r\n  const hasUrl = function (arr, url) {\r\n    let flag = false\r\n    arr.map((k, i) => {\r\n      if(url.indexOf(k) !== -1){\r\n        flag = true\r\n      }\r\n    })\r\n    return flag\r\n  }\r\n  const exAuthArr = ['restapi.amap.com', config.requestApiUrl.getValidateImg]\r\n  // 请求headers中移除auth\r\n  if (hasUrl(exAuthArr, url)) {\r\n    delete headers['auth'];\r\n  }\r\n\r\n  const exAppIdArr = ['verify/img/get', '/huieryun-identity/', 'restapi.amap.com']\r\n\r\n  // 请求headers中增加appId\r\n  if(!hasUrl(exAppIdArr, url)){\r\n    headers[\"appId\"] = config.appId;\r\n  }\r\n\r\n  //过滤获取经纬度报错问题\r\n  const exAuthArr1 = ['restapi.amap.com'];\r\n  // 请求headers中移除Pragma  Expires\r\n  if (hasUrl(exAuthArr1, url)) {\r\n    delete headers['Pragma'];\r\n    delete headers['Expires'];\r\n    delete headers['unitId'];\r\n  }\r\n\r\n  if(config.mock){\r\n    headers = {}\r\n  }\r\n  // console.log('headers:', headers);\r\n  switch (method.toLowerCase()) {\r\n    case 'get':\r\n      return axios.get(`${url}${options.data ? `?${qs.stringify(options.data)}` : ''}`, {headers, timeout})\r\n    case 'delete':\r\n      return axios.delete(`${url}${options.data ? `?${qs.stringify(options.data)}` : ''}`, {headers, timeout})\r\n    case 'head':\r\n      return axios.head(url, data, {headers, timeout})\r\n    case 'post':\r\n      let newData = data;\r\n      if ('' + headers['Content-type'] === 'application/x-www-form-urlencoded') {\r\n        newData = qs.stringify(data)\r\n      }\r\n      return axios.post(url, newData, {headers, timeout})\r\n    case 'put':\r\n      let putData = data;\r\n      if ('' + headers['Content-type'] === 'application/x-www-form-urlencoded') {\r\n        putData = qs.stringify(data)\r\n      }\r\n      return axios.put(url, putData, {headers, timeout})\r\n    case 'patch':\r\n      return axios.patch(url, data, {headers, timeout})\r\n    default:\r\n      return axios(options)\r\n  }\r\n}\r\n\r\n// 跳转到登录\r\nconst go2Login = function(isReload){\r\n  confirmCount = 1;\r\n  localStorage.removeItem('antdAdminSiderFold')\r\n  sessionStorage.removeItem('SIDER_OPEN_KEY')\r\n  sessionStorage.removeItem('SIDER_SELECTED_KEY')\r\n  Cookie.remove(config.cookie.userName);\r\n  Cookie.remove(config.cookie.auth);\r\n  //企业中心\r\n  if(config.sysType === 'entCenter') {\r\n    localStorage.removeItem(config.userInfoKey);\r\n  }\r\n  // 自定义登录跳转方法\r\n  customLoginRedirect()\r\n\r\n  // if(!!isReload){\r\n  //   window.location.reload();\r\n  // }\r\n}\r\n\r\n// 检测登录处理, isReload 未登录是否刷新\r\nconst checkLogin = function(isReload){\r\n  let auth = Cookie.get(config.cookie.auth);\r\n  // Cookie中无auth令牌，直接跳转到登录页面\r\n  if(!auth){\r\n    // 跳转登录\r\n    go2Login(isReload)\r\n  }\r\n  return false\r\n}\r\n\r\n//isHandCommErr： 是否需要request方法做统一全局报错处理\r\nexport default function request (options, isHandCommErr　) {\r\n\r\n  if(!options || !options.url){\r\n    reqInform({\r\n      title: '无效的url',\r\n      description: '请求选项中的url是无效的'\r\n    }, 'error')\r\n    return Promise.reject({resultCode: 1, resultMsg: '无效的url：' + options.url, data: null})\r\n  }\r\n\r\n  options.url = config.apiAppName(options.url);\r\n\r\n  //判断是否存在表情等特殊字符\r\n  if(options.data){\r\n    let emojiData = JSON.stringify(options.data);\r\n    var emojiRegRule = /\\uD83C[\\uDF00-\\uDFFF]|\\uD83D[\\uDC00-\\uDE4F]/g;\r\n    if (emojiData && emojiData.match(emojiRegRule)) {\r\n      messageInform('参数包含了特殊表情符号或其它不可辨识的符号', 'error');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return fetch(options).then((response) => {\r\n    const {statusText, status} = response\r\n    let data = options.isCross ? response.data.query.results.json : response.data\r\n\r\n    // Cookie中有auth令牌，表示已登录，但是auth失效的，则弹出窗口提示\r\n    if ('' + 401 === '' + response.status) {\r\n      // 检测是否登录\r\n      checkLogin(false)\r\n      // 若已登录，则检测auth是否失效\r\n      if(confirmCount < 1 ){\r\n        showConfirm().then((cRes) => {\r\n          if('1' === '' + cRes){\r\n            go2Login(false)\r\n          }else{\r\n            confirmCount = 0\r\n          }\r\n        })\r\n        confirmCount ++\r\n      }\r\n      return {resultCode: 0, resultMsg: '登录信息失效提示', data: null}\r\n    }\r\n\r\n    if((response.status !== '401' && isHandCommErr && (response.data.resultCode !== 0))) {\r\n      reqInform({\r\n        title: '系统提示',\r\n        description: response.data.resultMsg || '接口服务故障'\r\n      }, 'warn')\r\n    }\r\n\r\n    return {\r\n      resultCode: 0,\r\n      status,\r\n      resultMsg: statusText,\r\n      ...data,\r\n    }\r\n  }).catch((error) => {\r\n    const {response = {statusText: 'Network Error'}} = error\r\n    let errDesc = response.statusText || '接口服务故障';\r\n\r\n    // Cookie中有auth令牌，表示已登录，但是auth失效的，则弹出窗口提示 '1' === '' + error.errCode ||\r\n    if ('401' === '' + response.status) {\r\n      // 检测是否登录\r\n      checkLogin(true)\r\n      // 已登录，则检测auth是否失效\r\n      if(confirmCount < 1 ){\r\n        showConfirm().then((cRes) => {\r\n          if('1' === '' + cRes){\r\n            go2Login(true)\r\n          }else{\r\n            confirmCount = 0\r\n          }\r\n        })\r\n        confirmCount ++\r\n      }\r\n      return {resultCode: 0, resultMsg: '登录信息失效提示', data: null}\r\n    } else if('' + 406 === '' + response.status) {\r\n      // 如果服务接口响应406，一般是带有sql注入风险的关键字\r\n      errDesc = '查询内容包含sql注入风险的关键字';\r\n    }\r\n\r\n    reqInform({\r\n      title: '出现请求错误',\r\n      description: errDesc\r\n    }, 'error')\r\n\r\n    return {resultCode: 1, resultMsg: response.statusText, data: null}\r\n  })\r\n}\r\n"]}